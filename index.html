<html>
  <head>
    <title>Eurofurence Artshow - Art Battle</title>
  </head>

  <style>
    html, body {
	height: 100%;
	margin: 0;
	padding: 0;
    }
    #debug {
      text-align: left;
      background: #f1f1f1;
      width: 500px;
      min-height: 300px;
      display: none;
    }

    .dot {
	    height: 60px;
	    width: 60px;
	    border-radius: 50%;
	    border: 3px solid black;
	    display: inline-block;
	    margin-right: 30px;
    }

    #splash {
	text-align: left;
	width: 100%;
	min-height: 100%;
	display: none;
	background: #005953;
    }
    #splash_screen {
	width: 100%;
	height: 100%;
	min-height: 100%;
	display: grid;
	grid-template-columns: 1fr 1fr 1fr;
	grid-template-rows: 10% 1fr 10% 1fr 10% 1fr 10%;
    }
    #splash_title {
	display: flex;
	justify-content: center;
	align-items: center;
 	grid-column: 1 / 4;
	grid-row: 2 / 3;
	color: white;
	font-weight: bold;
	font-size: 60;
	text-align: center;
	overflow: hidden;
    }
    #splash_text {
 	grid-column: 2 / 3;
	grid-row: 4 / 5;
	text-align: center;
	vertical-align: top;
	font-size: 24;
	color: white;
    }
    #splash_stats {
 	grid-column: 2 / 3;
	grid-row: 6 / 7;
	text-align: center;
	font-size: 24;
	color: white;
    }

    #duel {
	text-align: left;
	width: 100%;
	min-height: 100%;
	display: none;
	background: #005953;
    }
    #duel_screen {
	width: 100%;
	height: 100%;
	min-height: 100%;
	display: grid;
	grid-template-columns: 50px 1fr 100px 1fr 50px;
	grid-template-rows: 15% 1fr 15%;
    }
    #duel_title {
	display: flex;
	justify-content: center;
	align-items: center;
 	grid-column: 1 / 6;
	grid-row: 1 / 2;
	color: white;
	font-weight: bold;
	font-size: 36;
	text-align: center;
	overflow: hidden;
    }
    #duel_image_1 {
 	grid-column: 2 / 3;
	grid-row: 2 / 3;
    }
    #duel_image_2 {
 	grid-column: 4 / 5;
	grid-row: 2 / 3;
    }
    .duel-images {
	overflow: hidden;
	display: flex;
	justify-content: center;
    }
    .duel-images img {
	width: 100%;
	height: auto;
	object-fit: contain;
    }
    #duel_text_1 {
 	grid-column: 2 / 3;
	grid-row: 3 / 4;
	display: flex;
	justify-content: center;
	align-items: center;
	color: white;
    }
    #duel_text_2 {
 	grid-column: 4 / 5;
	grid-row: 3 / 4;
	display: flex;
	justify-content: center;
	align-items: center;
	color: white;
    }

    .duel-winner {
	font-size: 30;
	font-weight: bold;
	background: red;
	position: relative;
	top: -50px;
	padding: 20px 100px 20px 100px;
    }
    .duel-winner pre {
	font-size: 30;
    }
    .duel-loser {
	font-size: 30;
	font-weight: bold;
	opacity: 0.4;
    }
    .duel-winner pre {
	font-size: 30;
    }

    #leaderboard {
	text-align: left;
	background: #208060;
	width: 100%;
	min-height: 100%;
	display: none;
    }
    .leaderboard {
	display: grid;
	min-height: 100%;
	height: 100%;
	width: 100%;
	grid-template-columns: 100px 1fr 100px 1fr 100px;
	grid-template-rows: repeat(6, 1fr) 20px;
	row-gap: 40px;
	background: #005953;
    }
    .leaderboard-header {
	display: flex;
	justify-content: center;
	align-items: center;
 	grid-column: 1 / 6;
	grid-row: 1 / 2;
	color: white;
	font-weight: bold;
	font-size: 60pt;
	text-align: center;
    }
    .leaderboard-entry-left {
 	grid-column: 2 / 3;
    }
    .leaderboard-entry-right {
 	grid-column: 4 / 5;
    }
    .leaderboard-entry {
	display: grid;
	grid-template-columns: 20% 1fr 30%;
	grid-template-rows: 1fr;
	overflow: hidden;
	background: #69a3a2;
    }
    .lb_position {
	display: flex;
	justify-content: center;
	align-items: center;
	height: 100%;
	min-height: 100%;
	background: #a2c5c4;
	font-weight: bold;
	font-size: 60;
 	grid-column: 1 / 2;
    }
    .lb_text {
	display: flex;
	padding-left: 30px;
	padding-right: 30px;
	justify-content: left;
	align-items: center;
	height: 100%;
	min-height: 100%;
	/* font-size: 24; */
 	grid-column: 2 / 3;
	overflow: hidden;
	font-size: calc((1vw + 1vh) * 10 / 13);
	text-overflow: ellipsis;
    }
    .lb_img {
 	grid-column: 3 / 4;
	overflow: hidden;
	display: flex;
	justify-content: center;
	background: #909090;
    }
    .lb_img img {
	max-width: 100%;
	max-height: 100%;
    }

    #error {
	    display: none;
    }
    #error_screen {
	text-align: center;
	background: red;
	width: 100%;
	height: 100%;
	min-height: 100%;
	display: grid;
	grid-template-columns: 1fr 1fr 1fr;
	grid-template-rows: repeat(5, 1fr);
    }
    #error_title {
 	grid-column: 2 / 3;
	grid-row: 2 / 3;
	text-color: black;
	font-weight: bold;
	font-size: 36pt;
	text-align: center;
    }
    #error_message {
 	grid-column: 2 / 3;
	grid-row: 4 / 5;
	text-color: black;
	font-weight: bold;
	font-size: 24pt;
	text-align: center;
    }

    #connect {
	width: 100%;
	min-height: 100%;
	display: none;
	background: #005953;
    }
    #connect_screen {
	width: 100%;
	height: 100%;
	min-height: 100%;
	display: grid;
	grid-template-columns: 100px 1fr 100px;
	grid-template-rows: 1fr 1fr 1fr;
    }
    #connect_title {
	display: flex;
	justify-content: center;
	align-items: center;
 	grid-column: 2 / 3;
	grid-row: 2 / 3;
	color: white;
	font-weight: bold;
	font-size: 60;
	text-align: center;
	overflow: hidden;
    }
  </style>

  <body>
    <pre id="debug"></pre>

    <div id="connect">
	    <div id="connect_screen">
		    <div id="connect_title">Waiting for server connection...</div>
	    </div>
    </div>

    <div id="error">
	    <div id="error_screen">
		    <div id="error_title">Game Server Error</div>
		    <div id="error_message"></div>
	    </div>
    </div>

    <div id="splash">
	    <div id="splash_screen">
		    <div id="splash_title">Art Battle</div>
		    <div id="splash_text">
			    <p><b>Two go in, one comes out.</b> Here, we pit two pieces of artwork
			    against each other, and you get to decide which one wins.</p>

			    <p>Press the red and blue buttons to vote.</p>

			    <p>Stop pressing buttons to see the leaderboard.</p>
		    </div>
		    <div id="splash_stats"></div>
	    </div>
    </div>

    <div id="duel">
	    <div id="duel_screen">
		    <div id="duel_title"></div>
		    <div class="duel-images" id="duel_image_1"><img id="duel_img_1" src=""></div>
		    <div class="duel-images" id="duel_image_2"><img id="duel_img_2" src=""></div>
		    <div id="duel_text_1"></div>
		    <div id="duel_text_2"></div>
	    </div>
    </div>

    <div id="leaderboard">
	<div id="lb_grid" class="leaderboard">
		<div class="leaderboard-header">Leaderboard</div>
		<div class="leaderboard-entry leaderboard-entry-left" id="lb_rank_1">
			<div class="lb_position" id="lb_position_rank_1">1</div>
			<div class="lb_text" id="lb_text_rank_1"></div>
			<div class="lb_img" id="lb_image_rank_1"><img id="lb_img_rank_1" src=""></div>
		</div>
		<div class="leaderboard-entry leaderboard-entry-right" id="lb_rank_6">
			<div class="lb_position" id="lb_position_rank_6">6</div>
			<div class="lb_text" id="lb_text_rank_6"></div>
			<div class="lb_img" id="lb_image_rank_6"><img id="lb_img_rank_6" src=""></div>
		</div>
		<div class="leaderboard-entry leaderboard-entry-left" id="lb_rank_2">
			<div class="lb_position" id="lb_position_rank_2">2</div>
			<div class="lb_text" id="lb_text_rank_2"></div>
			<div class="lb_img" id="lb_image_rank_2"><img id="lb_img_rank_2" src=""></div>
		</div>
		<div class="leaderboard-entry leaderboard-entry-right" id="lb_rank_7">
			<div class="lb_position" id="lb_position_rank_7">7</div>
			<div class="lb_text" id="lb_text_rank_7"></div>
			<div class="lb_img" id="lb_image_rank_7"><img id="lb_img_rank_7" src=""></div>
		</div>
		<div class="leaderboard-entry leaderboard-entry-left" id="lb_rank_3">
			<div class="lb_position" id="lb_position_rank_3">3</div>
			<div class="lb_text" id="lb_text_rank_3"></div>
			<div class="lb_img" id="lb_image_rank_3"><img id="lb_img_rank_3" src=""></div>
		</div>
		<div class="leaderboard-entry leaderboard-entry-right" id="lb_rank_8">
			<div class="lb_position" id="lb_position_rank_8">8</div>
			<div class="lb_text" id="lb_text_rank_8"></div>
			<div class="lb_img" id="lb_image_rank_8"><img id="lb_img_rank_8" src=""></div>
		</div>
		<div class="leaderboard-entry leaderboard-entry-left" id="lb_rank_4">
			<div class="lb_position" id="lb_position_rank_4">4</div>
			<div class="lb_text" id="lb_text_rank_4"></div>
			<div class="lb_img" id="lb_image_rank_4"><img id="lb_img_rank_4" src=""></div>
		</div>
		<div class="leaderboard-entry leaderboard-entry-right" id="lb_rank_9">
			<div class="lb_position" id="lb_position_rank_9">9</div>
			<div class="lb_text" id="lb_text_rank_9"></div>
			<div class="lb_img" id="lb_image_rank_9"><img id="lb_img_rank_9" src=""></div>
		</div>
		<div class="leaderboard-entry leaderboard-entry-left" id="lb_rank_5">
			<div class="lb_position" id="lb_position_rank_5">5</div>
			<div class="lb_text" id="lb_text_rank_5"></div>
			<div class="lb_img" id="lb_image_rank_5"><img id="lb_img_rank_5" src=""></div>
		</div>
		<div class="leaderboard-entry leaderboard-entry-right" id="lb_rank_10">
			<div class="lb_position" id="lb_position_rank_10">10</div>
			<div class="lb_text" id="lb_text_rank_10"></div>
			<div class="lb_img" id="lb_image_rank_10"><img id="lb_img_rank_10" src=""></div>
		</div>
	</div>
    </div>

    <script>
      var screens = ["duel", "decision", "timeout", "leaderboard", "splash", "error", "connect"];

      function displayScreen(s) {
	for (i in screens) {
	  elname = screens[i];
	  var el = document.getElementById(elname);
	  if (el === undefined || el == null)
	    continue;
	  if (elname == s) {
	    el.style.display = "block";
	  } else {
	    el.style.display = "none";
	  }
	}
      }

      function updateLeaderboard(json) {
	for (i = 0; i < 10; i++) {
	  var lb_div = document.getElementById("lb_rank_" + (i+1));
	  var lb_text = document.getElementById("lb_text_rank_" + (i+1));
	  var lb_image = document.getElementById("lb_image_rank_" + (i+1));
	  var lb_img = document.getElementById("lb_img_rank_" + (i+1));
	  if (lb_text == null)
	    continue;
	  if (i >= json.count) {
		/* less than ten entries -> blanks */
		lb_div.style.display = "none";
		lb_text.innerText = "";
		lb_img.src = "";
		continue;
          } else {
	    lb_div.style.display = "grid";
	    lb_img.src = "/" + json.entries[i].filename;
	    json.entries[i].title = json.entries[i].title.replace(/ /g, '&nbsp;');
	    json.entries[i].artist = json.entries[i].artist.replace(/ /g, '&nbsp;');
	    lb_text.innerHTML = `<div><b>${json.entries[i].title}</b><br>${json.entries[i].artist}<br>Art Show Panel: ${json.entries[i].panel}</div>`;
	  }
	}
      }

      function updateErrorScreen(json) {
	var el = document.getElementById("error_message");
	el.innerText = json.message;
      }

      function resetDuelScreenCSS() {
	var img1 = document.getElementById("duel_img_1");
	img1.style.opacity = "1";
	img1.style.filter = "saturate(100%)";
	var img2 = document.getElementById("duel_img_2");
	img2.style.opacity = "1";
	img2.style.filter = "saturate(100%)";
      }

      function buttonPress(button) {
	var j = JSON.stringify({"button": button});
	ws.send("BUTTON: "+j);
      }

      function updateDuelScreen(json) {
	resetDuelScreenCSS();
	var el = document.getElementById("duel_title");
        el.innerText = json.one.title + " vs. " + json.two.title;
	var img1 = document.getElementById("duel_img_1");
	img1.src = "/" + json.one.filename;
	var img2 = document.getElementById("duel_img_2");
	img2.src = "/" + json.two.filename;
	var t1 = document.getElementById("duel_text_1");
	t1.innerHTML = `<span class=\"dot\" id=\"red_dot\" style=\"background: red\"></span><div><b style="font-size: 24pt">${json.one.title}</b><br><b>${json.one.artist}</b><br>Elo Rating: ${json.one.elo_rating}<br>Art Show Panel: ${json.one.panel}</div>`;
	var t2 = document.getElementById("duel_text_2");
	t2.innerHTML = `<span class=\"dot\" id=\"blue_dot\" style=\"background: blue\"></span><div><b style="font-size: 24pt">${json.two.title}</b><br><b>${json.two.artist}</b><br>Elo Rating: ${json.two.elo_rating}<br>Art Show Panel: ${json.two.panel}</div>`;
	var rd = document.getElementById("red_dot");
	rd.onclick = function () { buttonPress("1"); };
	var bd = document.getElementById("blue_dot");
	bd.onclick = function () { buttonPress("2"); };
      }

      function updateTimeoutScreen(json) {
	resetDuelScreenCSS();
	var el = document.getElementById("duel_title");
        el.innerText = "Timeout";
	var img1 = document.getElementById("duel_img_1");
	img1.src = "/" + json.one.filename;
	img1.style.filter = "saturate(0%)";
	img1.style.opacity = "0.4";
	var img2 = document.getElementById("duel_img_2");
	img2.src = "/" + json.two.filename;
	img2.style.filter = "saturate(0%)";
	img2.style.opacity = "0.4";
	var t1 = document.getElementById("duel_text_1");
	var t2 = document.getElementById("duel_text_2");
	t1.innerHTML = `<div class=\"duel-winner\"">Timeout</div>`;
	t2.innerHTML = `<div class=\"duel-winner\"">Timeout</div>`;
      }

      function updateDecisionScreen(json) {
	resetDuelScreenCSS();
	var el = document.getElementById("duel_title");
        el.innerText = json.one.title + " vs. " + json.two.title;
	var img1 = document.getElementById("duel_img_1");
	img1.src = "/" + json.one.filename;
	var img2 = document.getElementById("duel_img_2");
	img2.src = "/" + json.two.filename;
	var t1 = document.getElementById("duel_text_1");
	var t2 = document.getElementById("duel_text_2");

	var winner;
	var el_winner_text;
	var el_winner_img;
	var el_loser_text;
	var el_loser_img;
	var winner_elo_diff;
	var loser_elo_diff;
	var winner_rank_diff;
	var loser_rank_diff;
	if (json.winner == "one") {
	  winner = json.one;
          el_winner_text = t1;
	  el_loser_text = t2;
	  el_winner_img = img1;
	  el_loser_img = img2;
	  winner_elo_diff = json.one_elo_diff;
	  winner_rank_diff = json.one_elo_diff;
	  loser_elo_diff = json.two_elo_diff;
	  loser_rank_diff = json.two_elo_diff;
	} else {
	  winner = json.two;
          el_winner_text = t2;
	  el_loser_text = t1;
	  el_winner_img = img2;
	  el_loser_img = img1;
	  winner_elo_diff = json.two_elo_diff;
	  winner_rank_diff = json.two_elo_diff;
	  loser_elo_diff = json.one_elo_diff;
	  loser_rank_diff = json.one_elo_diff;
	}
	el_winner_text.innerHTML = `<div class=\"duel-winner\"">Winner!<pre>${winner_elo_diff} Elo Rating Points</pre></div>`;
        el_loser_text.innerHTML = `<div class=\"duel-loser\"">Loser<pre>${loser_elo_diff} Elo Rating Points</pre></div>`;
	el_loser_img.style.filter = "saturate(0%)";
	el_loser_img.style.opacity = "0.4";
      }

      function updateSplashScreen(json) {
	var el = document.getElementById("splash_stats");
        el.innerText = json.duel_count + " duels have been played in total."
      }

      var ping_started = false;
      var ws;

      function connect() {
	      var url = 'ws://' + window.location.host + '/ws';
	      ws = new WebSocket(url);

	      ws.onopen = function() {
		if (!ping_started) {
		  ping_started = true;
		  setInterval(ping, 3000);
		}
	      	var el = document.getElementById("connect_title");
		el.innerText = "Waiting for game server command...";
		displayScreen("connect");
	      }

	      function ping() {
		if (ws !== undefined && ws.readyState === 1) {
		  ws.send("PING: {}");
		}
	      }

	      ws.onclose = function(e) {
		ws = undefined;
	      	var el = document.getElementById("connect_title");
		el.innerText = "Waiting for server connection...";
		displayScreen("connect");
		setTimeout(function() {
		  connect();
		}, 1000);
	      }

	      ws.onerror = function(e) {
		ws = undefined;
	      	var el = document.getElementById("connect_title");
		el.innerText = "Waiting for server connection...";
		displayScreen("connect");
		setTimeout(function() {
		  connect();
		}, 1000);
	      }

	      ws.onmessage = function(msg){
		mparts = msg.data.split(/: /)
		msg_type = mparts[0];
		mparts.shift();
		json_text = mparts.join(": ");
		if (typeof json_text === 'undefined') return;
		/* for some hellish javascript reason we have to run
	   	   JSON.parse() twice. Once for normalizing the string and
	   	   then again to get an object. This language is insane. */
		var json;
		if (json_text != "") {
		  try {
		    j = JSON.parse(json_text);
		    if (typeof(j) == "object") {
		      json = j;
		    } else {
		      json = JSON.parse(j);
		    }
		  } catch(e) {
		    console.log("error parsing json: " + json_text)
		    return;
		  }
		}
		var el = document.getElementById("debug");
		if (msg_type == "PONG") {
		  // do nothing
		} else if (msg_type == "SPLASH") {
		  updateSplashScreen(json);
		  displayScreen("splash");
		} else if (msg_type == "TIMEOUT") {
		  updateTimeoutScreen(json);
		  displayScreen("duel");
		} else if (msg_type == "DECISION") {
		  updateDecisionScreen(json);
		  displayScreen("duel");
		} else if (msg_type == "DUEL") {
		  updateDuelScreen(json);
		  displayScreen("duel");
		} else if (msg_type == "LEADERBOARD") {
		  updateLeaderboard(json);
		  displayScreen("leaderboard");
		} else if (msg_type == "ERROR") {
		  updateErrorScreen(json);
		  displayScreen("error");
		} else {
		  // displayScreen("duel");
		  el.innerText = "event: " + mparts[0]; // + "\n" + mparts[1];
		}
	      }
      }
      displayScreen("connect");
      connect();
    </script>
  </body>
</html>

